<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
						"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="kr.kro.bbanggil.admin.mapper.AdminMapper">
	
	<resultMap id="adminMap" type="kr.kro.bbanggil.admin.dto.response.AdminResponseDto">
		<result property="userNo" column="USER_NO"></result>
		<result property="userName" column="USER_NAME"></result>
		<result property="userId" column="USER_Id"></result>
		<result property="userPhoneNum" column="USER_PHONENUM"></result>
		<result property="userEmail" column="USER_EMAIL"></result>
		<result property="userBirthdate" column="USER_BIRTHDATE"></result>
		<result property="userCreatedate" column="CREATED_DATE"></result>
		<result property="userType" column="USER_TYPE"></result>
		<result property="userBusinessNo" column="USER_BUSINESSNO"></result>
		<result property="agreeEmail" column="AGREE_EMAIL"></result>
		<result property="bakeryName" column="BAKERY_NAME"></result>
		<result property="bakeryNo" column="BAKERY_NO"></result>
		<result property="bakeryAddress" column="BAKERY_ADDRESS"></result>
		<result property="amenity" column="AMENITY"></result>
		<result property="insideInfo" column="INSIDE_INFO"></result>
		<result property="outsideInfo" column="OUTSIDE_INFO"></result>
		<result property="agree" column="AGREE"></result>
		<result property="submissionDate" column="SUBMISSION_DATE"></result>
		<result property="acceptDate" column="ACCEPT_DATE"></result>
		<collection property="bakeryImgPath" resultMap="imgPathMap"></collection>
	</resultMap>
	
	<resultMap id="imgPathMap"  type="kr.kro.bbanggil.admin.dto.response.BakeryImgResponseDto">
		<result property="resourcesPath" column="RESOURCES_PATH"/>
       	<result property="changeName" column="CHANGE_NAME"/>
	</resultMap>

	<select id="subList" resultMap="adminMap">
		SELECT bi.BAKERY_NO, ui.USER_ID, ui.USER_PHONENUM, 
			   ba.AGREE, bi.BAKERY_NAME, bd.SUBMISSION_DATE, 
			   ba.ACCEPT_DATE, ui.USER_NO
		FROM BAKERY_ACCESS ba
		JOIN USER_INFO ui ON ba.USER_NO = ui.USER_NO 
		JOIN BAKERY_INFO bi ON ba.BAKERY_NO = bi.BAKERY_NO
		JOIN BAKERY_DETAIL bd ON ba.BAKERY_NO = bd.BAKERY_NO 
		ORDER BY bi.BAKERY_NO DESC
	</select>
	
	<select id="acceptList" resultMap="adminMap">
		SELECT * FROM USER_INFO ui
		JOIN BUSINESSNO b ON ui.USER_NO = b.USER_NO
		JOIN BAKERY_ACCESS ba ON ui.USER_NO = ba.USER_NO 
		JOIN BAKERY_INFO bi ON ba.BAKERY_NO = bi.BAKERY_NO
		JOIN BAKERY_DETAIL bd ON ba.BAKERY_NO = bd.BAKERY_NO
		JOIN BAKERY_IMAGE bi2 ON bi2.BAKERY_NO = bi.BAKERY_NO
		WHERE ui.USER_NO = #{userNo} AND ba.BAKERY_NO = #{bakeryNo}
	</select>
	
	<update id="update">
		UPDATE BAKERY_ACCESS SET AGREE = #{action}, REJECT = #{rejectReason}, ACCEPT_DATE = SYSDATE 
		WHERE BAKERY_NO = #{bakeryNo}
	</update>
	
	<select id="bakeryList" resultMap="adminMap">
		SELECT bi.BAKERY_NO, ui.USER_ID, ui.USER_PHONENUM, 
			   bi.BAKERY_NAME, bi.BAKERY_ADDRESS, bi.BAKERY_NO, ui.USER_NO 
		FROM BAKERY_ACCESS ba
		JOIN USER_INFO ui ON ba.USER_NO = ui.USER_NO 
		JOIN BAKERY_INFO bi ON ba.BAKERY_NO = bi.BAKERY_NO
		JOIN BAKERY_DETAIL bd ON ba.BAKERY_NO = bd.BAKERY_NO
		WHERE ba.AGREE = '승인' 
		ORDER BY bi.BAKERY_NO DESC
	</select>
	
	<select id="bakeryDetailList" resultMap="adminMap">
		SELECT * FROM USER_INFO ui
		JOIN BUSINESSNO b ON ui.USER_NO = b.USER_NO
		JOIN BAKERY_ACCESS ba ON ui.USER_NO = ba.USER_NO 
		JOIN BAKERY_INFO bi ON ba.BAKERY_NO = bi.BAKERY_NO
		JOIN BAKERY_DETAIL bd ON ba.BAKERY_NO = bd.BAKERY_NO
		JOIN BAKERY_IMAGE bi2 ON bi2.BAKERY_NO = bi.BAKERY_NO
		WHERE ui.USER_NO = #{userNo} AND ba.BAKERY_NO = #{bakeryNo}
	</select>
	
	<select id="userList" resultMap="adminMap">
		SELECT ui.USER_NO, ui.USER_ID, ui.USER_EMAIL, ui.USER_PHONENUM, 
			   ui.USER_TYPE, a.AGREE_EMAIL
		FROM USER_INFO ui 
		JOIN AGREE a ON ui.USER_NO = a.USER_NO
		ORDER BY ui.USER_NO DESC
	</select>
	
	<select id="userDetailList" resultMap="adminMap">
		<!-- SELECT * FROM (
			SELECT ROWNUM AS rn, f.* FROM (
							SELECT ui.USER_NO, ui.USER_ID, ui.USER_EMAIL, ui.USER_PHONENUM, ui.USER_TYPE, 
								   a.AGREE_EMAIL, ui.CREATED_DATE, ui.USER_NAME, ui.USER_BIRTHDATE
							FROM USER_INFO ui 
							JOIN AGREE a ON ui.USER_NO = a.USER_NO 
							ORDER BY ui.USER_NO)f)m
			WHERE rn = #{listNum} -->
		
				
			SELECT ui.USER_NO, ui.USER_ID, ui.USER_EMAIL, ui.USER_PHONENUM, ui.USER_TYPE, 
				   a.AGREE_EMAIL, ui.CREATED_DATE, ui.USER_NAME, ui.USER_BIRTHDATE, b.USER_BUSINESSNO 
			FROM USER_INFO ui 
			JOIN AGREE a ON ui.USER_NO = a.USER_NO
			LEFT OUTER JOIN BUSINESSNO b ON ui.USER_NO = b.USER_NO
			WHERE ui.USER_NO = #{userNo}
	</select>
	
</mapper>